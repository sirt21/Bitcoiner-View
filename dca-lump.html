<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCA vs Lump Sum - Bitcoiner View</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo" onclick="window.location.href='index.html'" style="cursor: pointer;">Bitcoiner View</h1>
            <nav class="nav-links">
                <a href="spending.html">Bitcoin Spending</a>
                <a href="macro.html">Macro</a>
                <a href="dca-lump.html" class="active">DCA/LUMP</a>
                <a href="contact.html">Contact</a>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="page-header">
                <h1><i class="fas fa-chart-line"></i> DCA vs Lump Sum Calculator</h1>
                <p>Compare Dollar Cost Averaging vs Lump Sum Bitcoin investment strategies</p>
            </div>

            <div class="calculator-container">
                <div class="input-section">
                    <div class="investment-amount-section">
                        <h3><i class="fas fa-dollar-sign"></i> Investment Amount</h3>
                        <div class="input-group">
                            <label for="investmentAmount">Total Investment ($)</label>
                            <input type="number" id="investmentAmount" placeholder="10000" min="1" step="1">
                        </div>
                    </div>

                    <div class="strategy-selection">
                        <h3><i class="fas fa-toggle-on"></i> Investment Strategy</h3>
                        <div class="strategy-toggle">
                            <button id="dcaBtn" class="strategy-btn active">
                                <i class="fas fa-calendar-alt"></i>
                                Dollar Cost Averaging
                            </button>
                            <button id="lumpBtn" class="strategy-btn">
                                <i class="fas fa-coins"></i>
                                Lump Sum
                            </button>
                        </div>
                    </div>

                    <!-- DCA Options -->
                    <div id="dcaOptions" class="strategy-options active">
                        <h4>DCA Configuration</h4>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="dcaStartDate">Start Date</label>
                                <input type="date" id="dcaStartDate">
                            </div>
                            <div class="input-group">
                                <label for="dcaAmount">DCA Amount ($)</label>
                                <input type="number" id="dcaAmount" placeholder="500" min="1" step="1">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="dcaFrequency">Frequency</label>
                            <select id="dcaFrequency">
                                <option value="weekly">Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                            </select>
                        </div>
                    </div>

                    <!-- Lump Sum Options -->
                    <div id="lumpOptions" class="strategy-options">
                        <h4>Lump Sum Configuration</h4>
                        <div class="input-group">
                            <label for="lumpDate">Investment Date</label>
                            <input type="date" id="lumpDate">
                        </div>
                    </div>

                    <button id="calculateBtn" class="calculate-btn">
                        <i class="fas fa-calculator"></i>
                        Calculate Returns
                    </button>
                </div>

                <div class="results-section">
                    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Calculating returns...</p>
                    </div>

                    <div id="resultsContainer" class="results-container" style="display: none;">
                        <h3><i class="fas fa-chart-bar"></i> Investment Results</h3>
                        
                        <div class="results-grid">
                            <div class="result-card">
                                <div class="result-icon">
                                    <i class="fab fa-bitcoin"></i>
                                </div>
                                <div class="result-content">
                                    <h4>Bitcoin Acquired</h4>
                                    <p id="btcAmount" class="result-value">0.00000000 BTC</p>
                                </div>
                            </div>

                            <div class="result-card">
                                <div class="result-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="result-content">
                                    <h4>Current Value</h4>
                                    <p id="currentValue" class="result-value">$0.00</p>
                                </div>
                            </div>

                            <div class="result-card">
                                <div class="result-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="result-content">
                                    <h4>Total Gains</h4>
                                    <p id="totalGains" class="result-value">$0.00</p>
                                </div>
                            </div>

                            <div class="result-card">
                                <div class="result-icon">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="result-content">
                                    <h4>Return %</h4>
                                    <p id="returnPercentage" class="result-value">0.00%</p>
                                </div>
                            </div>
                        </div>

                        <div class="investment-summary">
                            <h4>Investment Summary</h4>
                            <div id="summaryDetails" class="summary-details">
                                <!-- Summary will be populated by JavaScript -->
                            </div>
                        </div>

                        <div class="chart-section">
                            <h4>Investment Performance Over Time</h4>
                            <div class="chart-container">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div id="errorMessage" class="error-message" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Unable to calculate returns. Please check your inputs and try again.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let currentStrategy = 'dca';
        let bitcoinPriceData = {};
        let performanceChart = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
        });

        function initializePage() {
            // Set default dates
            const today = new Date();
            const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            
            document.getElementById('dcaStartDate').value = oneYearAgo.toISOString().split('T')[0];
            document.getElementById('lumpDate').value = oneYearAgo.toISOString().split('T')[0];
            
            // Set default investment amount
            document.getElementById('investmentAmount').value = '10000';
            document.getElementById('dcaAmount').value = '500';
        }

        function setupEventListeners() {
            // Strategy toggle buttons
            document.getElementById('dcaBtn').addEventListener('click', () => switchStrategy('dca'));
            document.getElementById('lumpBtn').addEventListener('click', () => switchStrategy('lump'));
            
            // Calculate button
            document.getElementById('calculateBtn').addEventListener('click', calculateReturns);
            
            // Input validation
            document.getElementById('investmentAmount').addEventListener('input', validateInputs);
            document.getElementById('dcaAmount').addEventListener('input', validateInputs);
        }

        function switchStrategy(strategy) {
            currentStrategy = strategy;
            
            // Update button states
            document.getElementById('dcaBtn').classList.toggle('active', strategy === 'dca');
            document.getElementById('lumpBtn').classList.toggle('active', strategy === 'lump');
            
            // Show/hide options
            document.getElementById('dcaOptions').classList.toggle('active', strategy === 'dca');
            document.getElementById('lumpOptions').classList.toggle('active', strategy === 'lump');
            
            // Clear previous results
            hideResults();
        }

        function validateInputs() {
            const investmentAmount = parseFloat(document.getElementById('investmentAmount').value);
            const dcaAmount = parseFloat(document.getElementById('dcaAmount').value);
            
            if (currentStrategy === 'dca' && dcaAmount > investmentAmount) {
                document.getElementById('dcaAmount').value = investmentAmount;
            }
        }

        async function calculateReturns() {
            const investmentAmount = parseFloat(document.getElementById('investmentAmount').value);
            
            if (!investmentAmount || investmentAmount <= 0) {
                showError('Please enter a valid investment amount');
                return;
            }

            showLoading();
            
            try {
                if (currentStrategy === 'dca') {
                    await calculateDCAReturns();
                } else {
                    await calculateLumpSumReturns();
                }
            } catch (error) {
                console.error('Calculation error:', error);
                showError('Unable to calculate returns. Please try again.');
            }
        }

        async function calculateDCAReturns() {
            const investmentAmount = parseFloat(document.getElementById('investmentAmount').value);
            const dcaAmount = parseFloat(document.getElementById('dcaAmount').value);
            const startDate = new Date(document.getElementById('dcaStartDate').value);
            const frequency = document.getElementById('dcaFrequency').value;
            
            if (!dcaAmount || dcaAmount <= 0) {
                showError('Please enter a valid DCA amount');
                return;
            }

            // Calculate number of purchases
            const today = new Date();
            const daysDiff = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const intervalDays = frequency === 'weekly' ? 7 : 30;
            const numberOfPurchases = Math.floor(daysDiff / intervalDays);
            
            if (numberOfPurchases <= 0) {
                showError('Start date must be in the past');
                return;
            }

            // Generate purchase dates and amounts
            const purchases = [];
            let totalInvested = 0;
            let totalBTC = 0;
            
            for (let i = 0; i < numberOfPurchases; i++) {
                const purchaseDate = new Date(startDate);
                purchaseDate.setDate(purchaseDate.getDate() + (i * intervalDays));
                
                if (totalInvested + dcaAmount <= investmentAmount) {
                    const btcPrice = await getBitcoinPrice(purchaseDate);
                    const btcPurchased = dcaAmount / btcPrice;
                    
                    purchases.push({
                        date: purchaseDate,
                        amount: dcaAmount,
                        btcPrice: btcPrice,
                        btcPurchased: btcPurchased
                    });
                    
                    totalInvested += dcaAmount;
                    totalBTC += btcPurchased;
                }
            }

            // Get current Bitcoin price
            const currentBTCPrice = await getCurrentBitcoinPrice();
            const currentValue = totalBTC * currentBTCPrice;
            const totalGains = currentValue - totalInvested;
            const returnPercentage = (totalGains / totalInvested) * 100;

            // Display results
            displayResults({
                btcAmount: totalBTC,
                currentValue: currentValue,
                totalGains: totalGains,
                returnPercentage: returnPercentage,
                totalInvested: totalInvested,
                strategy: 'DCA',
                purchases: purchases,
                currentBTCPrice: currentBTCPrice
            });
        }

        async function calculateLumpSumReturns() {
            const investmentAmount = parseFloat(document.getElementById('investmentAmount').value);
            const investmentDate = new Date(document.getElementById('lumpDate').value);
            
            const today = new Date();
            if (investmentDate >= today) {
                showError('Investment date must be in the past');
                return;
            }

            // Get Bitcoin price on investment date
            const btcPriceAtPurchase = await getBitcoinPrice(investmentDate);
            const btcPurchased = investmentAmount / btcPriceAtPurchase;
            
            // Get current Bitcoin price
            const currentBTCPrice = await getCurrentBitcoinPrice();
            const currentValue = btcPurchased * currentBTCPrice;
            const totalGains = currentValue - investmentAmount;
            const returnPercentage = (totalGains / investmentAmount) * 100;

            // Display results
            displayResults({
                btcAmount: btcPurchased,
                currentValue: currentValue,
                totalGains: totalGains,
                returnPercentage: returnPercentage,
                totalInvested: investmentAmount,
                strategy: 'Lump Sum',
                investmentDate: investmentDate,
                btcPriceAtPurchase: btcPriceAtPurchase,
                currentBTCPrice: currentBTCPrice
            });
        }

        async function getBitcoinPrice(date) {
            // For demo purposes, generate realistic historical prices
            // In production, you would fetch from a real API
            const today = new Date();
            const daysDiff = Math.floor((today - date) / (1000 * 60 * 60 * 24));
            
            // Current price around $60,000, with historical volatility
            const currentPrice = 60000;
            const volatility = 0.02; // 2% daily volatility
            const trend = -0.0001; // Slight upward trend over time
            
            let price = currentPrice;
            for (let i = 0; i < daysDiff; i++) {
                const randomChange = (Math.random() - 0.5) * volatility * 2;
                price = price * (1 + randomChange - trend);
            }
            
            return Math.max(price, 1000); // Minimum price floor
        }

        async function getCurrentBitcoinPrice() {
            try {
                // Try to fetch real current price
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
                const data = await response.json();
                return data.bitcoin.usd;
            } catch (error) {
                // Fallback to estimated current price
                return 60000;
            }
        }

        function displayResults(results) {
            // Update result cards
            document.getElementById('btcAmount').textContent = results.btcAmount.toFixed(8) + ' BTC';
            document.getElementById('currentValue').textContent = '$' + results.currentValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalGains').textContent = '$' + results.totalGains.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('returnPercentage').textContent = results.returnPercentage.toFixed(2) + '%';
            
            // Update colors based on gains/losses
            const gainsElement = document.getElementById('totalGains');
            const percentageElement = document.getElementById('returnPercentage');
            
            if (results.totalGains >= 0) {
                gainsElement.style.color = '#00ff88';
                percentageElement.style.color = '#00ff88';
            } else {
                gainsElement.style.color = '#ff4444';
                percentageElement.style.color = '#ff4444';
            }

            // Update summary
            updateSummary(results);
            
            // Create performance chart
            createPerformanceChart(results);
            
            // Show results
            showResults();
        }

        function updateSummary(results) {
            const summaryContainer = document.getElementById('summaryDetails');
            let summaryHTML = '';
            
            if (results.strategy === 'DCA') {
                summaryHTML = `
                    <div class="summary-item">
                        <span class="summary-label">Strategy:</span>
                        <span class="summary-value">Dollar Cost Averaging</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Number of Purchases:</span>
                        <span class="summary-value">${results.purchases.length}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Average Purchase Price:</span>
                        <span class="summary-value">$${(results.totalInvested / results.btcAmount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Invested:</span>
                        <span class="summary-value">$${results.totalInvested.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Current BTC Price:</span>
                        <span class="summary-value">$${results.currentBTCPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                `;
            } else {
                summaryHTML = `
                    <div class="summary-item">
                        <span class="summary-label">Strategy:</span>
                        <span class="summary-value">Lump Sum</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Investment Date:</span>
                        <span class="summary-value">${results.investmentDate.toLocaleDateString()}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Purchase Price:</span>
                        <span class="summary-value">$${results.btcPriceAtPurchase.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Invested:</span>
                        <span class="summary-value">$${results.totalInvested.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Current BTC Price:</span>
                        <span class="summary-value">$${results.currentBTCPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                `;
            }
            
            summaryContainer.innerHTML = summaryHTML;
        }

        function createPerformanceChart(results) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            let chartData = [];
            let labels = [];
            
            if (results.strategy === 'DCA') {
                // Create cumulative performance data for DCA
                let cumulativeInvested = 0;
                let cumulativeBTC = 0;
                
                results.purchases.forEach((purchase, index) => {
                    cumulativeInvested += purchase.amount;
                    cumulativeBTC += purchase.btcPurchased;
                    
                    labels.push(purchase.date.toLocaleDateString());
                    chartData.push({
                        x: purchase.date.toLocaleDateString(),
                        y: cumulativeBTC * results.currentBTCPrice
                    });
                });
            } else {
                // Create simple before/after for lump sum
                labels = [results.investmentDate.toLocaleDateString(), new Date().toLocaleDateString()];
                chartData = [
                    { x: results.investmentDate.toLocaleDateString(), y: results.totalInvested },
                    { x: new Date().toLocaleDateString(), y: results.currentValue }
                ];
            }
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Portfolio Value ($)',
                        data: chartData,
                        borderColor: '#f7931a',
                        backgroundColor: 'rgba(247, 147, 26, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#f7931a',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#f7931a',
                            bodyColor: '#fff',
                            borderColor: '#f7931a',
                            borderWidth: 2
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ccc',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ccc'
                            }
                        }
                    }
                }
            });
        }

        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showResults() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').querySelector('p').textContent = message;
        }

        function hideResults() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>
